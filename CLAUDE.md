# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Backend (Go / PocketBase) — run from `app/`

```bash
# Run backend in dev mode (auto-migration enabled, uses test DB)
go run main.go serve --dir="./test_pb_data"

# Run all tests
go test ./...

# Run tests with coverage report (opens HTML)
make test-report

# Build production binary
make all        # clean + UI build + Go build
go build -o tybalt main.go  # Go only
```

### Frontend (SvelteKit) — run from `ui/`

```bash
npm run dev      # Start Vite dev server (requires backend running)
npm run build    # Production build (output copied to app/pb_public/)
npm run check    # TypeScript/Svelte type checking
npm run lint     # Prettier + ESLint check
npm run format   # Auto-format code
```

### Full dev setup (two terminals)

```bash
# Terminal 1
cd app && go run main.go serve --dir="./test_pb_data"

# Terminal 2
cd ui && npm run dev
# App available at http://localhost:5173
```

**Required**: Create `ui/.env` with:
```
PUBLIC_POCKETBASE_URL=http://localhost:8090
```

### Versioning

```bash
./scripts/increment-version.sh build   # increment build number
./scripts/increment-version.sh minor   # increment minor, reset build
./scripts/increment-version.sh major   # increment major, reset minor+build
```

---

## Architecture

### Backend: `app/`

PocketBase-based Go application. Entry point is `main.go`, which registers:
- **Hooks** (`hooks/AddHooks`) — database lifecycle event handlers
- **Routes** (`routes/AddRoutes`) — custom API endpoints beyond PocketBase's built-ins
- **Cron jobs** (`cron/AddCronJobs`) — scheduled tasks
- **Migrations** (`migrations/`) — applied automatically on startup; new migrations auto-generated when using `go run` (not `go build`)

**Key packages:**
- `hooks/` — Business logic enforced at the DB layer (validation, cascade updates, auth gating). Each collection has a dedicated `*_hooks.go` file. Hooks use `errs.HookError` and `AnnotateHookError` for structured error responses.
- `routes/` — REST handlers. Files named `*_api.go` for CRUD, `*_writeback.go` for Firebase sync, `*_tracking.go` for activity tracking. SQL queries in `.sql` files alongside Go files.
- `utilities/` — Shared helpers including `config.go` (feature flags), `po_approvers.go` (approval hierarchy), `expenditure_kinds.go` (expense categories).
- `constants/` — Application-wide constants including default values.
- `errs/` — Custom error types (`HookError` with HTTP status + structured data).
- `absorb/` — Entity-merge ("absorb") logic with commit-order dependency tracking.
- `notifications/` — Notification queuing and delivery.

**Static files**: The built UI (`ui/build/`) is copied to `app/pb_public/` and embedded into the binary via `//go:embed all:pb_public/**`. The `all:` prefix is required to include files starting with `_` (generated by Vite).

### Frontend: `ui/`

SvelteKit 2 + Svelte 5 + TypeScript + Tailwind CSS 4. PocketBase SDK is used directly for data fetching (see `src/lib/pocketbase.ts`).

- `src/lib/components/` — Shared UI components
- `src/lib/stores/` — Svelte reactive stores for shared state
- `src/lib/types/` — TypeScript types (auto-generated PocketBase types in `pocketbase-types.ts`)
- `src/lib/utilities.ts` — Business logic helpers
- `src/lib/navConfig.ts` — Navigation structure
- `src/lib/poVisibility.ts` — Purchase order visibility rules
- `src/routes/` — SvelteKit pages organized by domain (jobs, expenses, time, pos, clients, vendors, etc.)

### Data Import Tool: `import_data/`

Standalone Go CLI for one-way MySQL → SQLite sync via Parquet. It runs independently from the main app and is not part of the PocketBase binary.

- `--export`: MySQL → Parquet files (idempotent, deterministic IDs)
- `--import`: Parquet → SQLite (upsert, sets `_imported=true`)
- `--cleanup`: Remove orphaned imported records
- `--attachments`: GCS → S3 attachment migration

Records with `_imported=true` originated from MySQL. Locally-created records have no `_imported` field. Hooks that check `RecordHasMeaningfulChanges(record, "_imported")` skip propagation when only `_imported` changed.

---

## Key Business Concepts

**Purchase Orders (POs)**: Central to the approval workflow. Approval authority is determined by `po_approver_props` per user, with limits varying by expenditure kind (`capital`, `project`, `sponsorship`, `staff_and_social`, `media_and_event`, `computer`). See `authority_matrix.md` for the full matrix.

**Expenditure Kinds**: Mapped to columns in `po_approver_props`. The `capital` kind (no job, `allow_job=false`) uses `max_amount`. The `project` kind (requires job, `allow_job=true`) uses `project_max`. Other kinds have dedicated columns.

**Feature Flags**: Checked via `utilities.IsExpensesEditingEnabled(app)`. When expenses editing is disabled, create/update/delete hooks on expenses, purchase_orders, and vendors all return an error before proceeding.

**Writeback**: Changes to certain records (POs, expenses, user profiles) are synced to Firebase for legacy system compatibility, handled by `*_writeback.go` route files.

**Migrations**: Go migration files in `app/migrations/`. PocketBase auto-generates migration stubs when schema changes are made via the admin UI while running with `go run`. Never delete or reorder migrations.
