<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://www.unpkg.com/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('page', () => ({
        pb: {},
        authStore: {},
        loggedIn: false,
        items: [],
        init() {
          this.pb = new PocketBase("http://localhost:8090")
          // if the user is already logged in, set the authStore 
          if (this.pb.authStore.isValid) {
            this.authStore = this.pb.authStore
            this.loggedIn = true
          }
          this.loadData()
        },
        logout() {
          this.authStore.clear()
          this.loggedIn = false
        },
        async loginWithMicrosoft () {
          const authData = await this.pb.collection('users').authWithOAuth2({ provider: 'microsoft' });
          // if the user is logged in, set the authStore
          if (this.pb.authStore.isValid) {
            this.authStore = this.pb.authStore
            this.loggedIn = true
            this.loadData()
          }
        },
        loadData() {
          // load all of the items
          this.pb.collection('time_entries').getFullList({
            expand: 'job,time_type,division'
          }).then(items => {
            this.items = items
          }).catch(err => { console.error(`loading items ${err}`) })
        },
        hoursString(item) {
          const hoursArray = [];
          if (item.hours) hoursArray.push(item.hours + " hrs");
          if (item.mealsHours) hoursArray.push(item.meals_hours + " hrs meals");
          return hoursArray.join(" + ");
        },
      }));
    });
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-neutral-200" x-data="page">
  <header class="w-screen h-10 bg-neutral-700 text-white px-3 flex justify-between">
    <h1 class="h-full flex flex-col justify-center">Tybalt</h1>
    <template x-if="loggedIn">
      <div class="h-full">
      <!-- user is logged in -->
      <span class="flex items-center h-full gap-2">
        <span x-text="authStore.model.email"></span>
        <button class="bg-blue-500 hover:bg-blue-700 text-white text-sm py-1 px-2 rounded" @click="logout()">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M16.5 3.75a1.5 1.5 0 0 1 1.5 1.5v13.5a1.5 1.5 0 0 1-1.5 1.5h-6a1.5 1.5 0 0 1-1.5-1.5V15a.75.75 0 0 0-1.5 0v3.75a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3V5.25a3 3 0 0 0-3-3h-6a3 3 0 0 0-3 3V9A.75.75 0 1 0 9 9V5.25a1.5 1.5 0 0 1 1.5-1.5h6ZM5.78 8.47a.75.75 0 0 0-1.06 0l-3 3a.75.75 0 0 0 0 1.06l3 3a.75.75 0 0 0 1.06-1.06l-1.72-1.72H15a.75.75 0 0 0 0-1.5H4.06l1.72-1.72a.75.75 0 0 0 0-1.06Z" clip-rule="evenodd" />
          </svg>    
        </button>
      </span>
    </div>
    </template>
  </header>
  <main>
    <template x-if="loggedIn">
      <!-- Show the list of items here -->
      <ul class="flex flex-col">
        <!-- iterate over each key in the object -->
        <template x-for="item in items">
          <li class="flex even:bg-neutral-200 odd:bg-neutral-100">
            <div class="w-32" x-text="item.date"></div>
            <div class="flex flex-col w-full">
              <div class="headline_wrapper">
                <div class="headline">
                  <template x-if="item.expand.time_type.code === 'R'">
                    <span x-text="item.expand.division.name"></span>
                  </template>
                  <template x-if="item.expand.time_type.code !== 'R'">
                    <span x-text="item.expand.time_type.name"></span>
                  </template>
                </div>
                <div class="byline">
                  <template x-if="item.expand.time_type.code === 'OTO'">
                    <span x-text="`$${item.payoutRequestAmount}`"></span>
                  </template>
                </div>
              </div>
              <div class="firstline" >
                <template x-if="['R', 'RT'].includes(item.expand.time_type.code) && item.job !== ''" >
                  <span x-text="item.expand.job.number"></span>
                  <template x-if="item.expand.job.category">
                    <span class="label" x-text="item.expand.job.category"></span>
                  </template>
                </template>
              </div>
              <div class="secondline" x-text="hoursString(item)"></div>
              <template x-if="item.description">
                <div class="thirdline">
                  <template x-if="item.work_record !== ''">
                    <span x-text="`Work Record: ${ item.work_record } / `"></span>
                  </template>
                  <span x-text="item.description"></span>
                </div>
              </template>
            </div>
            <div class="rowactionsbox">
              <a href="/placeholder.html">a link</a>
            </div>
          </li>  
        </template>
      </ul>
    </template>
    <!-- The login box, centered vertically and horizontally using flex -->
    <template x-if="!loggedIn">
      <div class="flex flex-col justify-center items-center h-screen">
        <div class="flex flex-col items-center align-center rounded w-96 p-4 bg-neutral-100 border">
          <h1 class="text-4xl font-bold">Welcome to Tybalt</h1>
          <p class="text-lg">Login with Microsoft to get started</p>
          <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold m-2 py-2 px-4 rounded" @click="loginWithMicrosoft()">
            Login
          </button>
        </div>
      </div>
    </template>
  </main>
</body>
</html>