<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://www.unpkg.com/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('page', () => ({
        pb: {},
        authStore: {},
        loggedIn: false,
        jobs: [],
        errors: {},
        item: {
          // date in YYYY-MM-DD format 
          date: new Date().toISOString().split('T')[0],
          time_type: 'sdyfl3q7j7ap849',
          division: 'vccd5fo56ctbigh'
        },
        timetypes: [],
        divisions: [],
        newJob: {},
        init() {
          // this.$watch('item.time_type', value => console.log(value))
          this.pb = new PocketBase("http://localhost:8090")
          // if the user is already logged in, set the authStore 
          if (this.pb.authStore.isValid) {
            this.authStore = this.pb.authStore
            this.loggedIn = true
          }
          this.loadData()
        },
        logout() {
          this.authStore.clear()
          this.loggedIn = false
        },
        get trainingTokensInDescriptionWhileRegularHours () {
          if (
            this.item.time_type !== undefined &&
            this.item.description !== undefined
          ) {
            const lowercase = this.item.description.toLowerCase().trim();
            const lowercaseTokens = lowercase.split(/\s+/);
            return (
              this.hasTimeType(['R']) &&
              ([
                "training",
                "train",
                "orientation",
                "course",
                "whmis",
                "learning",
              ].some((token) => lowercaseTokens.includes(token)) ||
                ["working at heights", "first aid"].some((token) =>
                  lowercase.includes(token)
                ))
            );
          }
          return false;
        },
        get jobNumbersInDescription() {
          if (this.item.description !== undefined) {
            const lowercase = this.item.description.toLowerCase().trim();
            // look for any instances of XX-YYY where XX is a number between 15 and
            // 40 and YYY is a zero-padded number between 1 and 999 then return true
            // if any are found
            return /(1[5-9]|2[0-9]|3[0-9]|40)-(\d{3})/.test(lowercase);
          }
          return false;
        },
        get isWorkTime() {
          return this.hasTimeType(['R', 'RT'])
        },
        hasTimeType (typelist) {
          if (this.timetypes.length === 0) {
            return false;
          }
          return typelist
            .map(c => this.timetypes.find(t => t.code === c).id)
            .includes(this.item.time_type);
        },
        async loginWithMicrosoft () {
          const authData = await this.pb.collection('users').authWithOAuth2({ provider: 'microsoft' });
          // if the user is logged in, set the authStore
          if (this.pb.authStore.isValid) {
            this.authStore = this.pb.authStore
            this.loggedIn = true
            this.loadData()
          }
        },
        loadData() {
          // load all of the jobs
          this.pb.collection('jobs').getFullList().then(jobs => {
            this.jobs = jobs
          }).catch(err => { console.error(`loading jobs: ${err}`) })

          // load all of the timetypes
          this.pb.collection('time_types').getFullList().then(timetypes => {
            this.timetypes = timetypes
          }).catch(err => { console.error(`loading timetypes ${err}`) })

          // load all of the divisions
          this.pb.collection('divisions').getFullList().then(divisions => {
            this.divisions = divisions
          }).catch(err => { console.error(`loading divisions ${err}`) })
        },
        async save() {
          // set the uid from the authStore We do it here rather than the
          // backend because the
          // OnRecordBeforeCreateRequest("time_entries").Add() hook runs *AFTER*
          // schema validation (!)
          // https://github.com/pocketbase/pocketbase/discussions/2881 so we
          // need a correct value in the payload just to make it to the hook
          this.item.uid = this.authStore.model.id

          // set the week_ending date based on the first Saturday after the date
          // in this.item.date
          // TODO: do this in the backend as a go function in pocketbase
          // app.OnRecordBeforeCreateRequest("time_entries").Add() hook. We will
          // just send the date as a string in the format YYYY-MM-DD and the
          // hook will set the week_ending field
          const date = new Date(this.item.date);
          const weekEnding = new Date(date);
          weekEnding.setDate(date.getDate() + (6 - date.getDay()));
          this.item.week_ending = weekEnding.toISOString().split("T")[0];

          // TODO: are we editing an existing record or creating a new one?
          // right now we are just creating a new one
          try {
            const record = await this.pb.collection('time_entries').create(this.item, { returnRecord: true })

            // submission was successful, clear the errors
            this.errors = {}

            // clear the item
            this.item = {
              date: new Date().toISOString().split('T')[0],
              time_type: 'sdyfl3q7j7ap849',
              division: 'vccd5fo56ctbigh'
            }
          } catch (error) {
            this.errors = error.data.data
          }
        },
      }));
    });
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-neutral-200" x-data="page">
  <header class="w-screen h-10 bg-neutral-700 text-white px-3 flex justify-between">
    <h1 class="h-full flex flex-col justify-center">Tybalt</h1>
    <template x-if="loggedIn">
      <div class="h-full">
      <!-- user is logged in -->
      <span class="flex items-center h-full gap-2">
        <span x-text="authStore.model.email"></span>
        <button class="bg-blue-500 hover:bg-blue-700 text-white text-sm py-1 px-2 rounded" @click="logout()">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M16.5 3.75a1.5 1.5 0 0 1 1.5 1.5v13.5a1.5 1.5 0 0 1-1.5 1.5h-6a1.5 1.5 0 0 1-1.5-1.5V15a.75.75 0 0 0-1.5 0v3.75a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3V5.25a3 3 0 0 0-3-3h-6a3 3 0 0 0-3 3V9A.75.75 0 1 0 9 9V5.25a1.5 1.5 0 0 1 1.5-1.5h6ZM5.78 8.47a.75.75 0 0 0-1.06 0l-3 3a.75.75 0 0 0 0 1.06l3 3a.75.75 0 0 0 1.06-1.06l-1.72-1.72H15a.75.75 0 0 0 0-1.5H4.06l1.72-1.72a.75.75 0 0 0 0-1.06Z" clip-rule="evenodd" />
          </svg>    
        </button>
      </span>
    </div>
    </template>
  </header>
  <main>
    <template x-if="loggedIn">
      <form class="flex flex-col items-center w-full gap-2 p-2">
        <span class="flex flex-col w-full gap-2" x-init="flatpickr($refs.date, {
          inline: true,
          minDate: '2024-06-01',
          // 2 months from now
          maxDate: new Date(new Date().setMonth(new Date().getMonth() + 3)),
          enableTime: false,
          // dateFormat: 'Y-m-d',
          dateFormat: 'Z',
          defaultDate: item.date,
        });">
          <label for="date">Date</label>
          <input
            class="flex-1"
            type="text"
            name="date"
            placeholder="Date"
            x-ref="date"
            x-model.trim="item.date"
          />
        </span>
        <span class="flex w-full gap-2">
          <label for="timetype">Time Type</label>
          <select name="timetype" x-model="item.time_type">
            <template x-for="t in timetypes" :key="t.id">
              <option x-text="`${t.code} - ${t.name}`" :value="t.id" :selected="t.id === item.time_type"></option>
            </template>
          </select>
        </span>
        <template x-if="trainingTokensInDescriptionWhileRegularHours">
          <span class="flex w-full gap-2 text-red-600 bg-red-200">
            ^Should you choose training instead?
          </span>
        </template>
    
        <!----------------------------------------------->
        <!-- FIELDS VISIBLE ONLY FOR R or RT TimeTypes -->
        <!----------------------------------------------->
        <template x-if="isWorkTime">
          <span class="flex w-full gap-2">
            <label for="division">Division</label>
            <select name="division" x-model="item.division">
              <template x-for="d in divisions" :key="d.id">
                <option x-text="`${d.code} - ${d.name}`" :value="d.id" :selected="d.id === item.division"></option>
              </template>
            </select>
          </span>
        </template>
        <template x-if="isWorkTime">
          <span class="flex w-full gap-2">
            <label for="job">Job</label>
            <select name="job" x-model="item.job">
              <option value="">No Job</option>
              <template x-for="j in jobs" :key="j.id">
                <option x-text="`${j.job_number} -`" :value="j.id" :selected="j.id === item.job"></option>
              </template>
            </select>
          </span>  
        </template>
        <template x-if="isWorkTime && item.job && item.job !== '' && item.division">
          <div class="flex flex-col w-full gap-2" :class="{'bg-red-200': errors.job_hours !== undefined}">
            <span class="flex w-full gap-2">
              <label for="job_hours">Job Hours</label>
              <input
              class="flex-1"
              type="number"
              name="job_hours"
              x-model.number="item.job_hours"
              step="0.5"
              min="0"
              max="18"
              />
            </span>
            <template x-if="errors.job_hours !== undefined">
              <span x-text="errors.job_hours.message" class="text-red-600"></span>
            </template>
          </div>
          </div>
        </template>
    
        <!--------------------------------------------------->
        <!-- END FIELDS VISIBLE ONLY FOR R or RT TimeTypes -->
        <!--------------------------------------------------->
    
        <!-- TODO: The item.job === undefined below is predecated on the
        autocomplete clearing the property. Right now we are using a text field
        so it will never show up after being set once -->
        <template x-if="!hasTimeType(['OR', 'OW', 'OTO']) && (item.job === undefined || item.job === '')">
          <div class="flex flex-col w-full gap-2" :class="{'bg-red-200': errors.hours !== undefined}">
            <span class="flex w-full gap-2">
              <label for="hours">Hours</label>
              <input
                class="flex-1"
                type="number"
                name="hours"
                x-model.number="item.hours"
                step="0.5"
                min="0"
                max="18"
              />
            </span>
            <template x-if="errors.hours !== undefined">
              <span x-text="errors.hours.message" class="text-red-600"></span>
            </template>
          </div>
        </template>
    
        <template x-if="item.division && isWorkTime">
          <div class="flex flex-col w-full gap-2" :class="{'bg-red-200': errors.meals_hours !== undefined}">
            <span class="flex w-full gap-2">
              <label for="mealsHours">Meals Hours</label>
              <input
                class="flex-1"
                type="number"
                name="mealsHours"
                x-model.number="item.meals_hours"
                step="0.5"
                min="0"
                max="2"
              />
            </span>
            <template x-if="errors.meals_hours !== undefined">
              <span x-text="errors.meals_hours.message" class="text-red-600"></span>
            </template>
          </div>
        </template>
    
        <template x-if="item.job && item.job !== '' && item.division && isWorkTime">
          <div class="flex flex-col w-full gap-2" :class="{'bg-red-200': errors.work_record !== undefined}">
            <span class="flex w-full gap-2">
              <label for="workRecord">Work Record</label>
              <input
                class="flex-1"
                type="text"
                name="workRecord"
                placeholder="Work Record"
                x-model="item.work_record"
              />
            </span>
            <template x-if="errors.work_record !== undefined">
              <span x-text="errors.work_record.message" class="text-red-600"></span>
            </template>
          </div>
        </template>
        <template x-if="!hasTimeType(['OR', 'OW', 'OTO', 'RB'])">
          <div class="flex flex-col w-full gap-2" :class="{'bg-red-200': errors.description !== undefined}">
          <span class="flex w-full gap-2">
            <label for="description">Description</label>
            <input
            class="flex-1"
            type="text"
            name="description"
            placeholder="Description (5 char minimum)"
            x-model.trim="item.description"
            />
          </span>
          <template x-if="errors.description !== undefined">
            <span x-text="errors.description.message" class="text-red-600"></span>
          </template>
        </div>
      </template>
        <template x-if="jobNumbersInDescription">
          <span class="text-red-600 bg-red-200">
            Job numbers are not allowed in the description. Enter jobs numbers in
            the appropriate field and create one time entry per job.
          </span>
        </template>
        <template x-if="hasTimeType(['OTO'])">
          <div class="flex flex-col w-full gap-2" :class="{'bg-red-200': errors.payout_request_amount !== undefined}">
            <span class="flex w-full gap-2">
              $<input
              class="flex-1"
              type="number"
              name="payoutRequestAmount"
              placeholder="Amount"
              x-model.number="item.payout_request_amount"
              step="0.01"
              />
            </span>
            <template x-if="errors.payout_request_amount !== undefined">
              <span x-text="errors.payout_request_amount.message" class="text-red-600"></span>
            </template>
          </div>
        </template>
    
        <div class="flex flex-col w-full gap-2" :class="{'bg-red-200': errors.global !== undefined}">
          <span class="flex w-full gap-2">
            <template x-if="!jobNumbersInDescription">
              <button type="button" x-on:click="save()">
                Save
              </button>
            </template>
            <button type="button" v-on:click="$router.push(parentPath)">
              Cancel
            </button>
          </span>
          <template x-if="errors.global !== undefined">
            <span x-text="errors.global.message" class="text-red-600"></span>
          </template>
        </div>
      </form>    
    </template>
    <!-- The login box, centered vertically and horizontally using flex -->
    <template x-if="!loggedIn">
      <div class="flex flex-col justify-center items-center h-screen">
        <div class="flex flex-col items-center align-center rounded w-96 p-4 bg-neutral-100 border">
          <h1 class="text-4xl font-bold">Welcome to Tybalt</h1>
          <p class="text-lg">Login with Microsoft to get started</p>
          <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold m-2 py-2 px-4 rounded" @click="loginWithMicrosoft()">
            Login
          </button>
        </div>
      </div>
    </template>
  </main>
</body>
</html>